version: 2.1
jobs:
    install_dependencies:
        docker:
            - image: circleci/python:3.7.4
        steps:
            - checkout
            - restore_cache:
                keys:
                    - v1-dependencies-{{ checksum "requirements.txt" }}
            - run:
                name: Install dependencies
                command: |
                    python -m venv venv
                    . venv/bin/activate
                    pip install -r requirements.txt
            - save_cache:
                key: v1-dependencies-{{ checksum "requirements.txt" }}
                paths:
                    - "venv"

    test_code:
        docker:
            - image: circleci/python:3.7.4
        steps:
            - checkout
            - restore_cache:
                keys:
                    - v1-dependencies-{{ checksum "requirements.txt" }}
            - run:
                name: Run script main.py
                command: |
                    . venv/bin/activate
                    python main.py
                no_output_timeout: 1h

            - store_artifacts:
                path: /results
    ramav2:
        docker:
            - image: circleci/python:3.7.4
        steps:
            - checkout
            - attach_workspace:
                at: ~/project
            - restore_cache:
                keys:
                    - v1-dependencies-{{ checksum "requirements.txt" }}
            - run:
                name: Run main.py
                command: |
                    . venv/bin/activate
                    python main.py
                no_output_timeout: 1h
            - persist_to_workspace:
                root: ~/project
                paths:
                    - "results/decpv2.json"
    sendv2:
        docker:
            - image: circleci/python:3.9.4
        steps:
            - attach_workspace:
                at: ~/project
            - run:
                name: Transferts des donn√©es vers data eco
                command: |
                    lftp -u ${DEPLOY_USER}:${DEPLOY_PASSWORD} ${DEPLOY_HOST} -e "set ftp:ssl-force true ; set ssl:verify-certificate false; cd decp ; put results/decpv2.json ; quit"



workflows:
  version: 2
  main:
    jobs:
      - install_dependencies
      - ramav2:
            context:
                - decp-rama-context
            requires:
                - install_dependencies
    - sendv2:
            requires:
                - ramav2